<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gioco 4x4 - Trova i Gruppi - GIOCO #7 </title>
  <style>
    :root{ --gap:10px; --size:70vmin; }
    body{font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;display:flex;flex-direction:column;align-items:center;gap:18px;padding:24px;background:linear-gradient(180deg,#f7fbff,#eef6ff);min-height:100vh;color:#0b2540}
    h1{margin:0;font-size:clamp(18px,3vw,26px)}
    .board{width:var(--size);max-width:520px;aspect-ratio:1/1;display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:1fr;gap:var(--gap);padding:var(--gap);box-sizing:border-box}
    .cell{display:flex;align-items:center;justify-content:center;background:white;border-radius:12px;box-shadow:0 6px 18px rgba(10,25,50,0.08);cursor:pointer;user-select:none;padding:8px;text-align:center;font-weight:600;font-size:clamp(12px,2.2vw,16px);transition:transform .12s ease, box-shadow .12s ease}
    .cell:active{transform:translateY(2px)}
    .cell.disabled{opacity:0.85;cursor:default}
    .controls{display:flex;gap:8px;align-items:center}
    button.btn{background:#0b62a6;color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:#0b62a6;border:2px solid #0b62a6}
    .info{display:flex;gap:12px;align-items:center}
    .message{min-height:28px;font-weight:700}
    .attempts{font-size:14px;opacity:0.9}
    .selected{background:#0b62a6;color:white;outline:3px solid rgba(255,255,255,0.6);box-shadow:0 8px 20px rgba(11,98,166,0.2)}
    footer{margin-top:12px;font-size:13px;color:#27405b}
    /* colors for found groups */
    .color-0{background:linear-gradient(180deg,#c6f6d5,#9ae6b4)}
    .color-1{background:linear-gradient(180deg,#fed7d7,#feb2b2)}
    .color-2{background:linear-gradient(180deg,#fef9c3,#fef08a)}
    .color-3{background:linear-gradient(180deg,#cfe8ff,#9ecbff)}
    .hud{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    /* end screen */
    #endScreen{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.98);z-index:999;padding:40px;text-align:center;overflow:auto}
    #endSquares div{width:70px;height:70px;border-radius:12px;box-shadow:0 6px 18px rgba(10,25,50,0.08)}
  </style>
</head>
<body>
  <h1>Trova i 4 gruppi (4 parole ciascuno)</h1>
  <div class="hud">
    <div id="timer" style="font-size:16px;font-weight:700;color:#0b2540">Tempo: 00:00</div>
    <div class="info">
      <div class="message" id="message">Seleziona 4 parole per formare un gruppo - GIOCO #7 </div>
      <div class="attempts" id="attempts">Tentativi rimasti: 4</div>
    </div>
    <div class="controls">
      <button class="btn" id="resetBtn">Ricomincia</button>
      <button class="ghost" id="shuffleBtn">Rimescola parole</button>
    </div>
  </div>

  <div class="board" id="board"></div>

  <footer>Regole: Seleziona 4 caselle. Se formano uno dei gruppi nascosti verranno colorate e disabilitate.</footer>
  <div id="explanations" style="margin-top:18px;font-weight:600;font-size:15px;color:#0b2540"></div>

  <!-- End screen overlay (mostrato a fine partita) -->
  <div id="endScreen">
    <h2>Riepilogo finale</h2>
    <div id="endSquares" style="display:flex;gap:20px;justify-content:center;margin:20px 0;"></div>
    <div id="endTime" style="font-size:18px;margin:10px 0;"></div>
    <div id="endErrors" style="font-size:18px;margin:10px 0;"></div>
    <button id="closeEndBtn" style="padding:10px 20px;font-size:16px;border-radius:8px;border:none;background:#0b2540;color:white;cursor:pointer;">Torna al gioco</button>
  </div>

<script>
(function(){
  // --- Config
  const groups = [
    ['STORNO','RESO','SCONTO','REPARTO'],
    ['STERNA','STARNA','MERLO','CORVO'],
    ['SERTO','GHIRLANDA','DIADEMA','CORONA'],
    ['SORTE','TERSO','ESTRO','RESTO']
  ];

  const explanations = [
    'Voci registratore di cassa',
    'Uccelli',
    'Si mettono sulla testa',
    'Anagrammi'
  ];

  const groupColors = ['color-0','color-1','color-2','color-3'];

  // --- Stato
  let words = [];
  groups.forEach((g,gi)=> g.forEach(w => words.push({text:w, group:gi})));

  let attemptsLeft = 4;
  let errorsCount = 0;
  let foundGroups = new Set();
  let resolutionOrder = []; // ordine in cui i gruppi sono stati trovati (by group index)

  let timer = 0;
  let timerInterval = null;

  let selectedIndices = [];

  // --- Elementi
  const boardEl = document.getElementById('board');
  const messageEl = document.getElementById('message');
  const attemptsEl = document.getElementById('attempts');
  const resetBtn = document.getElementById('resetBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const endScreen = document.getElementById('endScreen');
  const endSquares = document.getElementById('endSquares');
  const endTime = document.getElementById('endTime');
  const endErrors = document.getElementById('endErrors');
  const closeEndBtn = document.getElementById('closeEndBtn');

  // --- Utility
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

  function startTimer(){
    if(timerInterval) return;
    timerInterval = setInterval(()=>{
      timer++;
      let m = String(Math.floor(timer/60)).padStart(2,'0');
      let s = String(timer%60).padStart(2,'0');
      document.getElementById('timer').textContent = 'Tempo: ' + m + ':' + s;
    },1000);
  }

  function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

  function renderBoard(){
    boardEl.innerHTML = '';
    words.forEach((w,idx)=>{
      const btn = document.createElement('button');
      btn.className = 'cell';
      btn.textContent = w.text;
      btn.dataset.idx = idx;
      if(w.found) btn.classList.add('disabled');
      btn.addEventListener('click', onCellClick);
      boardEl.appendChild(btn);
    });
  }

  function updateHUD(){ attemptsEl.textContent = 'Tentativi rimasti: ' + attemptsLeft; }

  let _msgTimer = null;
  function setMessage(txt, persistMs = 2000){
    messageEl.textContent = txt;
    if(_msgTimer) clearTimeout(_msgTimer);
    if(persistMs > 0) _msgTimer = setTimeout(()=>{ messageEl.textContent = ''; }, persistMs);
  }

  function onCellClick(e){
    const btn = e.currentTarget;
    const idx = Number(btn.dataset.idx);
    const w = words[idx];
    if(w.found) return; // non selezionabile

    if(selectedIndices.includes(idx)){
      selectedIndices = selectedIndices.filter(i=>i!==idx);
      btn.classList.remove('selected');
    } else {
      if(selectedIndices.length>=4) return;
      selectedIndices.push(idx);
      btn.classList.add('selected');
    }

    startTimer();

    if(selectedIndices.length===4) checkSelection();
  }

  function checkSelection(){
    const selectedGroups = selectedIndices.map(i=>words[i].group);
    const firstGroup = selectedGroups[0];
    const allSame = selectedGroups.every(g=>g===firstGroup);

    if(allSame && !foundGroups.has(firstGroup)){
      // corretto
      foundGroups.add(firstGroup);
      resolutionOrder.push(firstGroup);

      selectedIndices.forEach(i=>{
        const btn = boardEl.querySelector(".cell[data-idx='"+i+"']");
        if(btn){
          btn.classList.remove('selected');
          btn.classList.add('disabled', groupColors[firstGroup]);
          btn.disabled = true;
        }
        words[i].found = true;
      });

      setMessage('Gruppo trovato!', 2000);

      if(foundGroups.size===groups.length){
        // vittoria
        setMessage('BRAVO', 0);
        Array.from(boardEl.children).forEach(c=>c.disabled=true);
        stopTimer();
        showFinalResults(true);
      }

    } else {
      // sbagliato
      errorsCount++;
      attemptsLeft -= 1;
      setMessage('RIPROVA', 2000);
      updateHUD();

      selectedIndices.forEach(i=>{
        const btn = boardEl.querySelector(".cell[data-idx='"+i+"']");
        if(btn) btn.classList.remove('selected');
      });

      if(attemptsLeft<=0){
        setMessage('PECCATO', 0);
        revealRemaining();
        Array.from(boardEl.children).forEach(c=>c.disabled=true);
        stopTimer();
        showFinalResults(false);
      }
    }

    selectedIndices = [];
  }

  function revealRemaining(){
    groups.forEach((g,gi)=>{
      if(foundGroups.has(gi)) return;
      words.forEach((w,idx)=>{
        if(w.group===gi){
          const btn = boardEl.querySelector(".cell[data-idx='"+idx+"']");
          if(btn){ btn.classList.add(groupColors[gi]); btn.classList.add('disabled'); btn.disabled = true; }
        }
      });
    });
  }

  function showExplanations(){
    const box = document.getElementById('explanations');
    box.innerHTML = '';
    groups.forEach((g,i)=>{
      const row = document.createElement('div');
      row.textContent = g.join(', ') + ' â†’ ' + explanations[i];
      box.appendChild(row);
    });
  }

  function showFinalResults(won){
    // mostra spiegazioni e schermata finale con quadrati nell'ordine di risoluzione
    showExplanations();

    // prepara end screen
    endSquares.innerHTML = '';

    // mostra i gruppi nell'ordine in cui sono stati risolti
    resolutionOrder.forEach(idx=>{
      const d = document.createElement('div');
      d.className = groupColors[idx];
      endSquares.appendChild(d);
    });

    // se ci sono gruppi non risolti, aggiungili in coda (per completezza)
    for(let gi=0; gi<groups.length; gi++){
      if(!resolutionOrder.includes(gi)){
        const d = document.createElement('div');
        d.className = groupColors[gi];
        endSquares.appendChild(d);
      }
    }

    // tempo e errori
    const finalTime = document.getElementById('timer').textContent.replace('Tempo: ','');
    endTime.textContent = 'Tempo impiegato: ' + finalTime;
    endErrors.textContent = 'Errori commessi: ' + errorsCount;

    endScreen.style.display = 'block';
  }

  function closeEndScreen(){ endScreen.style.display = 'none'; }

  // --- reset
  function resetGame(){
    stopTimer();
    timer = 0;
    document.getElementById('timer').textContent = 'Tempo: 00:00';
    attemptsLeft = 4;
    errorsCount = 0;
    foundGroups = new Set();
    resolutionOrder = [];
    selectedIndices = [];
    words.forEach(w=>{ delete w.found; });
    shuffle(words);
    document.getElementById('explanations').innerHTML = '';
    endScreen.style.display = 'none';
    renderBoard();
    updateHUD();
    setMessage('Seleziona 4 parole per formare un gruppo.', 2000);
  }

  // eventi
  resetBtn.addEventListener('click', resetGame);
  shuffleBtn.addEventListener('click', ()=>{ shuffle(words); renderBoard(); setMessage('Parole rimescolate.',1500); });
  closeEndBtn.addEventListener('click', closeEndScreen);

  // inizializzazione
  shuffle(words);
  renderBoard();
  updateHUD();

})();
</script>
</body>
</html>


